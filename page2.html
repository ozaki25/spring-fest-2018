<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>決済システムの内製化への旅 ‒ SpringとPCFで作るクラウドネイティブなシステム開発 | Spring Fest 2018</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/spring-fest-2018/assets/css/styles.09634a89.css" as="style"><link rel="preload" href="/spring-fest-2018/assets/js/app.09634a89.js" as="script"><link rel="preload" href="/spring-fest-2018/assets/js/15.38065252.js" as="script"><link rel="prefetch" href="/spring-fest-2018/assets/css/1.styles.8eb308c1.css"><link rel="prefetch" href="/spring-fest-2018/assets/css/2.styles.a2bd3099.css"><link rel="prefetch" href="/spring-fest-2018/assets/js/1.8eb308c1.js"><link rel="prefetch" href="/spring-fest-2018/assets/js/10.febcc01a.js"><link rel="prefetch" href="/spring-fest-2018/assets/js/11.1cd7b66f.js"><link rel="prefetch" href="/spring-fest-2018/assets/js/12.1f19ecf6.js"><link rel="prefetch" href="/spring-fest-2018/assets/js/13.8b9c0905.js"><link rel="prefetch" href="/spring-fest-2018/assets/js/14.c645b9f5.js"><link rel="prefetch" href="/spring-fest-2018/assets/js/16.3e425ef2.js"><link rel="prefetch" href="/spring-fest-2018/assets/js/17.fae3e6e8.js"><link rel="prefetch" href="/spring-fest-2018/assets/js/18.ffb2b096.js"><link rel="prefetch" href="/spring-fest-2018/assets/js/19.790c48e6.js"><link rel="prefetch" href="/spring-fest-2018/assets/js/2.a2bd3099.js"><link rel="prefetch" href="/spring-fest-2018/assets/js/20.c2857ee8.js"><link rel="prefetch" href="/spring-fest-2018/assets/js/21.1daad431.js"><link rel="prefetch" href="/spring-fest-2018/assets/js/22.87665903.js"><link rel="prefetch" href="/spring-fest-2018/assets/js/23.93c086fc.js"><link rel="prefetch" href="/spring-fest-2018/assets/js/24.51308b9b.js"><link rel="prefetch" href="/spring-fest-2018/assets/js/25.4266236e.js"><link rel="prefetch" href="/spring-fest-2018/assets/js/26.99ce27f6.js"><link rel="prefetch" href="/spring-fest-2018/assets/js/27.9ac45d54.js"><link rel="prefetch" href="/spring-fest-2018/assets/js/3.9378e134.js"><link rel="prefetch" href="/spring-fest-2018/assets/js/4.5c19490d.js"><link rel="prefetch" href="/spring-fest-2018/assets/js/5.ca23a0c0.js"><link rel="prefetch" href="/spring-fest-2018/assets/js/6.d229d9ff.js"><link rel="prefetch" href="/spring-fest-2018/assets/js/7.cdcc80d9.js"><link rel="prefetch" href="/spring-fest-2018/assets/js/8.eac14a68.js"><link rel="prefetch" href="/spring-fest-2018/assets/js/9.5d5663db.js">
    <link rel="stylesheet" href="/spring-fest-2018/assets/css/1.styles.8eb308c1.css"><link rel="stylesheet" href="/spring-fest-2018/assets/css/2.styles.a2bd3099.css"><link rel="stylesheet" href="/spring-fest-2018/assets/css/styles.09634a89.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/spring-fest-2018/" class="home-link router-link-active"><!----> <span class="site-name">Spring Fest 2018</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><!---->  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>10:00〜10:45</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>11:00〜11:45</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/spring-fest-2018/page2.html" class="active sidebar-link">決済システムの内製化への旅 ‒ SpringとPCFで作るクラウドネイティブなシステム開発</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/spring-fest-2018/page2.html#内製化に至る過程" class="sidebar-link">内製化に至る過程</a></li><li class="sidebar-sub-header"><a href="/spring-fest-2018/page2.html#なぜpcf" class="sidebar-link">なぜPCF</a></li><li class="sidebar-sub-header"><a href="/spring-fest-2018/page2.html#技術の話" class="sidebar-link">技術の話</a></li></ul></li><li><a href="/spring-fest-2018/page3.html" class="sidebar-link">エンタープライズ・マイクロサービスの格⾔</a></li><li><a href="/spring-fest-2018/page4.html" class="sidebar-link">Spring Data for Apache GeodeでRDBいらずのアプリ開発をしよう！</a></li><li><a href="/spring-fest-2018/page5.html" class="sidebar-link">これからSpringを使う開発者が知っておくべきこと</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>13:15〜14:00</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>14:15〜15:00</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>15:30〜16:15</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>16:30〜17:15</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>17:30〜18:15</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="決済システムの内製化への旅-‒-springとpcfで作るクラウドネイティブなシステム開発"><a href="#決済システムの内製化への旅-‒-springとpcfで作るクラウドネイティブなシステム開発" aria-hidden="true" class="header-anchor">#</a> 決済システムの内製化への旅 ‒ SpringとPCFで作るクラウドネイティブなシステム開発</h1> <ul><li>槙 俊明(Pivotal)</li> <li>鈴⽊ 順也(ソフトバンク・ペイメント・サービス株式会社)</li></ul> <iframe src="//www.slideshare.net/slideshow/embed_code/key/dmcfSdQTKVO4YJ" width="595" height="485" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" allowfullscreen="allowfullscreen" style="border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;"></iframe> <div style="margin-bottom:5px"><strong><a href="//www.slideshare.net/makingx/springpcf-jsug-sfh1" title="決済システムの内製化への旅 - SpringとPCFで作るクラウドネイティブなシステム開発 #jsug #sf_h1" target="_blank">決済システムの内製化への旅 - SpringとPCFで作るクラウドネイティブなシステム開発 #jsug #sf_h1</a></strong> from <strong><a href="https://www.slideshare.net/makingx" target="_blank">Toshiaki Maki</a></strong></div> <h2 id="内製化に至る過程"><a href="#内製化に至る過程" aria-hidden="true" class="header-anchor">#</a> 内製化に至る過程</h2> <h3 id="_2016"><a href="#_2016" aria-hidden="true" class="header-anchor">#</a> 2016</h3> <ul><li>課題
<ul><li>開発は全てベンダ任せ</li> <li>開発環境も整ってない</li> <li>手作業によるミスが起きる</li></ul></li> <li>解決策
<ul><li>改善プロジェクト</li> <li>SpringBoot, Selenium</li> <li>github入れたり</li> <li>エンジニアが3人入社</li></ul></li></ul> <h3 id="_2017"><a href="#_2017" aria-hidden="true" class="header-anchor">#</a> 2017</h3> <ul><li>課題
<ul><li>サービスの状況を把握できない</li> <li>古いアーキテクチャで開発コスト増</li></ul></li> <li>解決策
<ul><li>監視ツール導入</li> <li>FWはSpringで統一</li> <li>jenkins, nexus, sonar</li></ul></li></ul> <h3 id="_2018"><a href="#_2018" aria-hidden="true" class="header-anchor">#</a> 2018</h3> <ul><li>決済システムの内製スタート
<ul><li>オンライン決済サービス</li> <li>加盟店にAPIを公開</li> <li>複数の決済手段で決済</li> <li>加盟店(8000件) -&gt; <strong>決済システム</strong> -&gt; 決済機関(40件)</li></ul></li> <li>求められてたこと
<ul><li>スピード感</li> <li>継続的な改善</li> <li>監視が容易で障害に強い</li> <li>-&gt; ベンダーに頼ると実現できないので内製で</li></ul></li> <li>PCF上に構築することに
<ul><li>槙さんがサポート</li></ul></li></ul> <h2 id="なぜpcf"><a href="#なぜpcf" aria-hidden="true" class="header-anchor">#</a> なぜPCF</h2> <ul><li>PCF
<ul><li>Pivotal Container Service
<ul><li>Kubernetes</li></ul></li> <li>Pivotal Application Service
<ul><li>Cloud Foundry</li></ul></li> <li>Pivotal Function Service
<ul><li>Knative, riffがベース</li></ul></li></ul></li> <li>この事例ではPvotal Application Serviceを採用
<ul><li>3つのうちどれが良いかはチーム構成ややりたいことによる</li></ul></li> <li>チーム体制
<ul><li>ops2名 - PCFの面倒見る</li> <li>dev3名 - アプリ作る</li></ul></li> <li>12factorに従って作ればPCFを意識しなくてもPCFで動く</li> <li>PaaS vs Kube
<ul><li>開発者視点で
<ul><li>いろんなことをやりたくなかった</li></ul></li></ul></li></ul> <h2 id="技術の話"><a href="#技術の話" aria-hidden="true" class="header-anchor">#</a> 技術の話</h2> <h3 id="全体アーキテクチャ"><a href="#全体アーキテクチャ" aria-hidden="true" class="header-anchor">#</a> 全体アーキテクチャ</h3> <ul><li>CI周り
<ul><li>Github</li> <li>Nexus</li> <li>Concourse</li></ul></li> <li>PAS</li> <li>RabbitMQ</li> <li>監視周り
<ul><li>Prometheus</li> <li>Grafana</li></ul></li> <li>ログ周り
<ul><li>Logstash</li> <li>Elasticserch</li> <li>Kibana</li></ul></li> <li>Dev環境とProd環境を用意
<ul><li>PAS以外のコンポーネントはBOSHで管理</li></ul></li></ul> <h3 id="アプリのアーキテクチャ"><a href="#アプリのアーキテクチャ" aria-hidden="true" class="header-anchor">#</a> アプリのアーキテクチャ</h3> <ul><li>マイクロサービスで作ってる
<ul><li>API Gateway
<ul><li>Spring Cloud Gayteway</li></ul></li> <li>ServiceA, B, C
<ul><li>決済機関単位で？作成</li></ul></li> <li>Hystrix入れてサーキットブレーカも
<ul><li>障害があった時に関係ない決済機関も使えなくなる訳にはいかない</li></ul></li> <li>決済機関から加盟店への通知はRabbitMQで非同期に連携
<ul><li>Spring Cloud Stream</li> <li>Notification Gateway</li> <li>通知失敗したらDeadLetterQueとして返ってくるので再送する</li></ul></li></ul></li> <li>PCFによるAutoscaler
<ul><li>急な負荷に対応する</li> <li>スケールに関してアプリ側が何か意識する必要はない</li></ul></li> <li>12factor
<ul><li>環境に依存する設定項目は環境変数に</li> <li>ログはファイルではなく標準出力に
<ul><li>絶対にロストしてはいけないデータはDBへ</li></ul></li></ul></li></ul> <h3 id="ci-cd"><a href="#ci-cd" aria-hidden="true" class="header-anchor">#</a> CI/CD</h3> <ul><li>Concouseで動かす
<ul><li>slackに通知</li> <li>github enterpriseと連携</li> <li>pushする -&gt; JUnit実行 -&gt; Sonarに結果送る -&gt; nexusへ配置 -&gt; 開発環境へリリース
<ul><li>本番では自動でバージョンのインクリメントとかも</li> <li>槙さん謹製の構成(どこかで見たことあるような構成)</li></ul></li></ul></li> <li>負荷テスト、E2Eテストも自動で
<ul><li>JMeterで負荷テスト
<ul><li>開発環境で毎日</li></ul></li> <li>E2Eテスト</li></ul></li> <li>Javaの複数バージョン対応
<ul><li>複数のバージョンでのテストをConcourseで同時に実行</li> <li>docker使ってるので複数バージョン並列実行を簡単にできる</li></ul></li></ul> <h3 id="observability"><a href="#observability" aria-hidden="true" class="header-anchor">#</a> Observability</h3> <ul><li>Observability
<ul><li>Tracing</li> <li>Metrics</li> <li>Logging</li></ul></li> <li>Zipkin使ってる
<ul><li>MySQLのJDBCの処理も見れるようになる
<ul><li>Brave MySQL</li></ul></li></ul></li> <li>Grafanaダッシュボードでメトリクス監視
<ul><li>BOSHで入れるとダッシュボードやアラートがデフォルトで入ってる</li> <li>micrometerの依存追加するだけで使える</li></ul></li> <li>Kibanaでログを見てる</li></ul></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/spring-fest-2018/page1.html" class="prev">
          KEYNOTE - The State of Spring, Java and Kotlin
        </a></span> <span class="next"><a href="/spring-fest-2018/page3.html">
          エンタープライズ・マイクロサービスの格⾔
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/spring-fest-2018/assets/js/15.38065252.js" defer></script><script src="/spring-fest-2018/assets/js/app.09634a89.js" defer></script>
  </body>
</html>
